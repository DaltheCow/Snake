<doctype html>
<html>
    <title>
        Snake
    </title>
    <canvas id="SnakeScreen" width="300" height="300" style="border: black solid 1px"> </canvas>
    <script type="text/javascript">
        var screen = document.querySelector("#SnakeScreen");
        var context = screen.getContext('2d');
        var model = {
            snakehead: {xPos: 140, yPos: 140, pastX: null, pastY: null, blockSize: 10, direction: 'E'},
            target: {xPos: null, yPos: null},
            refreshSpeed: 100,
            snakeArray: [],
            game: true,
            obj: function(xpos,ypos) {
                return {xPos: xpos, yPos: ypos, pastX: null, pastY: null};
            },
            newTarget: function() {
                model.target.xPos = 10 * Math.floor(Math.random() * 29);
                model.target.yPos = 10 * Math.floor(Math.random() * 29);
            },
            updatePos: function() {
                var SH = model.snakehead;
                SH.pastX = SH.xPos;
                SH.pastY = SH.yPos;
                if (SH.direction === 'E')
                    SH.xPos += SH.blockSize;
                else if (SH.direction === 'W')
                    SH.xPos -= SH.blockSize;
                else if (SH.direction === 'N')
                    SH.yPos -= SH.blockSize;
                else if (SH.direction === 'S')
                    SH.yPos += SH.blockSize;
            },
            updateSA: function() {
                var SA = model.snakeArray;
                SA[0].pastX = SA[0].xPos, SA[0].pastY = SA[0].yPos;
                SA[0].xPos = model.snakehead.pastX;
                SA[0].yPos = model.snakehead.pastY;
                for(var i = 1; i < SA.length; i++) {
                    SA[i].pastX = SA[i].xPos, SA[i].pastY = SA[i].yPos;
                    SA[i].xPos = SA[i-1].pastX, SA[i].yPos = SA[i-1].pastY;
                }
            },
            move: function () {
                addEventListener('keypress', function(event) {
                    if (event.charCode === 100) {
                        if (model.snakehead.direction != 'W')
                            model.snakehead.direction = 'E';
                    }
                    else if (event.charCode === 115) {
                        if (model.snakehead.direction != 'N')
                            model.snakehead.direction = 'S';
                    }
                    else if (event.charCode === 97) {
                        if (model.snakehead.direction != 'E')
                            model.snakehead.direction = 'W';
                    }
                    else if (event.charCode === 119) {
                        if (model.snakehead.direction != 'S')
                            model.snakehead.direction = 'N';
                    }
            }, false)},
            growth: function(j) {
                var SA = model.snakeArray;
                //for growths after first
                if (SA.length > 0) {
                    for (var i = 0; i<j; i++) {
                        model.snakeArray.push(model.obj(SA[SA.length-1].xPos, SA[SA.length-1].yPos));
                    }
                }
                //for first growth
                else {
                    for (var i = 0; i<j; i++) {
                        model.snakeArray.push(model.obj(model.snakehead.xPos, model.snakehead.yPos));
                    }
                }
            },
            collisions: function(x1,y1,x2,y2) {
                var sz = model.snakehead.blockSize;
                if (x1 > x2 - sz/2 && x1 - sz/2 < x2 + sz/2
                    && y1 > y2 - sz/2 && y1 - sz/2 < y2 + sz/2)
                    return true;
                else
                    return false;
            },
            targetCollisions: function() {
                var M = model;
                if(M.collisions(M.target.xPos, M.target.yPos, M.snakehead.xPos, M.snakehead.yPos)) {
                    M.growth(3);
                    M.newTarget();
                }
            },
            renderGame: function() {
                model.updatePos();
                model.updateSA();
                model.targetCollisions();

            }
        }

        var octopus = {
            init: function() {
                context.fillText("To Start Hit R", 120,140);
                model.newTarget();
                model.growth(4);
                var listener = function(event) {
                    if (event.charCode === 114) {
                        setInterval(function(){
                            octopus.render();
                        }, model.refreshSpeed);
                    removeEventListener('keypress', listener, false);
                    model.move();
                    }
                };
                addEventListener('keypress', listener, false);
            },
            render: function() {
                context.clearRect(0,0,300,300);
                var SH = model.snakehead;
                if (model.game) {
                    view.renderGame(SH.xPos, SH.yPos, SH.blockSize);
                    model.snakeArray.forEach(function(AE) {
                        view.renderGame(AE.xPos, AE.yPos, SH.blockSize);
                    });
                    view.renderGame(model.target.xPos,model.target.yPos, SH.blockSize);
                    model.renderGame();
                }
                else {
                    view.endScreen();
                }
            }
        }

        var view = {
            renderGame: function(x,y,size) {
                view.drawSnake(x,y,size);
            },
            drawSnake: function(x,y,size) {
                context.fillStyle = 'black';
                context.fillRect(x,y,size*9/10,size*9/10);
            },
            endScreen: function() {
                context.clearRect(0,0,300,300);
                context.font = '30px Verdana';
                context.fillText("Game Over",130,130);
            }
        }
        octopus.init();
    </script>
</html>